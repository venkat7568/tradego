<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeGo Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            color: #333;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .mode-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
        }

        .mode-live {
            background: #ef4444;
            color: white;
        }

        .mode-backtest {
            background: #10b981;
            color: white;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-header h2 {
            font-size: 24px;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .radio-group {
            display: flex;
            gap: 20px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-option input[type="radio"] {
            width: auto;
        }

        .hidden {
            display: none !important;
        }

        .warning-box {
            background: #fef2f2;
            border: 2px solid #ef4444;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            color: #991b1b;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #333;
        }

        .stat-value.positive {
            color: #10b981;
        }

        .stat-value.negative {
            color: #ef4444;
        }

        .stat-subtitle {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px;
            background: #f9fafb;
            color: #666;
            font-weight: 600;
            font-size: 13px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
        }

        tr:hover {
            background: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-buy {
            background: #dcfce7;
            color: #166534;
        }

        .badge-sell {
            background: #fee2e2;
            color: #991b1b;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .last-updated {
            font-size: 12px;
            color: #999;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üöÄ TradeGo Dashboard</h1>
            <div class="header-buttons">
                <span id="mode-badge" class="mode-badge">Loading...</span>
                <button class="btn btn-primary" onclick="openSettings()">‚öôÔ∏è Settings</button>
                <button id="start-btn" class="btn btn-success" onclick="startSystem()">‚ñ∂Ô∏è Start</button>
                <button id="stop-btn" class="btn btn-danger hidden" onclick="stopSystem()">‚èπÔ∏è Stop</button>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Capital</h3>
                <div class="stat-value" id="capital">--</div>
                <div class="stat-subtitle" id="capital-source">Loading...</div>
            </div>
            <div class="stat-card">
                <h3>Today's P&L</h3>
                <div class="stat-value" id="total-pnl">--</div>
                <div class="stat-subtitle" id="pnl-breakdown">--</div>
            </div>
            <div class="stat-card">
                <h3>Win Rate</h3>
                <div class="stat-value" id="win-rate">--</div>
                <div class="stat-subtitle" id="trades-summary">--</div>
            </div>
            <div class="stat-card">
                <h3>Open Positions</h3>
                <div class="stat-value" id="open-positions">--</div>
                <div class="stat-subtitle" id="portfolio-heat">--</div>
            </div>
        </div>

        <!-- Open Trades -->
        <div class="section">
            <h2>üìä Open Trades</h2>
            <div id="open-trades-container">
                <div class="loading">Loading open trades...</div>
            </div>
        </div>

        <!-- Recent Closed Trades -->
        <div class="section">
            <h2>üìú Recent Closed Trades (Last 7 Days)</h2>
            <div id="closed-trades-container">
                <div class="loading">Loading closed trades...</div>
            </div>
        </div>

        <div class="last-updated" id="last-updated">Last updated: --</div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Trading Settings</h2>
                <button class="close-btn" onclick="closeSettings()">&times;</button>
            </div>

            <form id="settings-form" onsubmit="saveSettings(event)">
                <!-- Mode Selection -->
                <div class="form-group">
                    <label>Trading Mode</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="mode-backtest" name="mode" value="BACKTEST" onchange="updateModeFields()">
                            <label for="mode-backtest">üìù Backtest</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="mode-live" name="mode" value="LIVE" onchange="updateModeFields()">
                            <label for="mode-live">üî¥ Live</label>
                        </div>
                    </div>
                </div>

                <!-- Backtest Fields -->
                <div id="backtest-fields" class="hidden">
                    <div class="form-group">
                        <label>From Date</label>
                        <input type="date" id="backtest-from" name="backtest_from">
                    </div>
                    <div class="form-group">
                        <label>To Date</label>
                        <input type="date" id="backtest-to" name="backtest_to">
                    </div>
                    <div class="form-group">
                        <label>Paper Money Amount (‚Çπ)</label>
                        <input type="number" id="backtest-capital" name="capital" step="1000" placeholder="100000">
                    </div>
                </div>

                <!-- Live Fields -->
                <div id="live-fields" class="hidden">
                    <div class="form-group">
                        <label>Live Type</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="live-paper" name="live_type" value="PAPER" onchange="updateLiveType()">
                                <label for="live-paper">üìù Paper Money</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="live-real" name="live_type" value="REAL" onchange="updateLiveType()">
                                <label for="live-real">üí∞ Real Money</label>
                            </div>
                        </div>
                    </div>

                    <div id="paper-amount" class="form-group hidden">
                        <label>Paper Money Amount (‚Çπ)</label>
                        <input type="number" id="live-capital" name="capital" step="1000" placeholder="100000">
                        <small>Trades in real market, but money is tracked by us</small>
                    </div>

                    <div id="real-warning" class="hidden warning-box">
                        ‚ö†Ô∏è REAL MONEY MODE - Actual money will be used from your Upstox account!
                    </div>
                </div>

                <!-- Common Settings -->
                <div class="form-group">
                    <label>Max Open Positions</label>
                    <input type="number" id="max-positions" name="max_positions" min="1" max="20" value="5">
                </div>

                <div class="form-group">
                    <label>Max Daily Loss (%)</label>
                    <input type="number" id="max-loss" name="max_daily_loss_percent" min="0.5" max="10" step="0.5" value="2">
                </div>

                <div class="form-group">
                    <label>Intraday Allocation (%)</label>
                    <input type="number" id="intraday-alloc" name="intraday_allocation" min="0" max="100" step="5" value="70">
                </div>

                <div class="form-group">
                    <label>Swing Allocation (%)</label>
                    <input type="number" id="swing-alloc" name="swing_allocation" min="0" max="100" step="5" value="30">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">üíæ Save Settings</button>
                    <button type="button" class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentSettings = {};

        // Format currency
        function formatCurrency(value) {
            return '‚Çπ' + value.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Format percentage
        function formatPercent(value) {
            return value.toFixed(2) + '%';
        }

        // Open settings modal
        function openSettings() {
            loadCurrentSettings();
            document.getElementById('settings-modal').classList.add('active');
        }

        // Close settings modal
        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        // Load current settings into form
        async function loadCurrentSettings() {
            try {
                const response = await fetch('/api/settings');
                const result = await response.json();

                if (result.success) {
                    currentSettings = result.data;

                    // Set mode
                    document.getElementById('mode-' + currentSettings.mode.toLowerCase()).checked = true;

                    // Set live type
                    if (currentSettings.live_type) {
                        document.getElementById('live-' + currentSettings.live_type.toLowerCase()).checked = true;
                    }

                    // Set values
                    document.getElementById('backtest-from').value = currentSettings.backtest_from || '';
                    document.getElementById('backtest-to').value = currentSettings.backtest_to || '';
                    document.getElementById('backtest-capital').value = currentSettings.capital || 100000;
                    document.getElementById('live-capital').value = currentSettings.capital || 100000;
                    document.getElementById('max-positions').value = currentSettings.max_positions || 5;
                    document.getElementById('max-loss').value = currentSettings.max_daily_loss_percent || 2;
                    document.getElementById('intraday-alloc').value = (currentSettings.intraday_allocation * 100) || 70;
                    document.getElementById('swing-alloc').value = (currentSettings.swing_allocation * 100) || 30;

                    updateModeFields();
                    updateLiveType();
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                alert('Error loading settings');
            }
        }

        // Update visible fields based on mode
        function updateModeFields() {
            const mode = document.querySelector('input[name="mode"]:checked').value;

            if (mode === 'BACKTEST') {
                document.getElementById('backtest-fields').classList.remove('hidden');
                document.getElementById('live-fields').classList.add('hidden');
            } else {
                document.getElementById('backtest-fields').classList.add('hidden');
                document.getElementById('live-fields').classList.remove('hidden');
            }
        }

        // Update visible fields based on live type
        function updateLiveType() {
            const liveType = document.querySelector('input[name="live_type"]:checked');
            if (!liveType) return;

            if (liveType.value === 'PAPER') {
                document.getElementById('paper-amount').classList.remove('hidden');
                document.getElementById('real-warning').classList.add('hidden');
            } else {
                document.getElementById('paper-amount').classList.add('hidden');
                document.getElementById('real-warning').classList.remove('hidden');
            }
        }

        // Save settings
        async function saveSettings(event) {
            event.preventDefault();

            const mode = document.querySelector('input[name="mode"]:checked').value;
            const settings = {
                mode: mode
            };

            if (mode === 'BACKTEST') {
                settings.backtest_from = document.getElementById('backtest-from').value;
                settings.backtest_to = document.getElementById('backtest-to').value;
                settings.capital = parseFloat(document.getElementById('backtest-capital').value);
                settings.live_type = 'PAPER';
            } else {
                const liveType = document.querySelector('input[name="live_type"]:checked').value;
                settings.live_type = liveType;

                if (liveType === 'PAPER') {
                    settings.capital = parseFloat(document.getElementById('live-capital').value);
                }
            }

            settings.max_positions = parseInt(document.getElementById('max-positions').value);
            settings.max_daily_loss_percent = parseFloat(document.getElementById('max-loss').value);
            settings.intraday_allocation = parseFloat(document.getElementById('intraday-alloc').value) / 100;
            settings.swing_allocation = parseFloat(document.getElementById('swing-alloc').value) / 100;

            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ Settings saved successfully!');
                    closeSettings();
                    refreshAll();
                } else {
                    alert('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Error saving settings');
            }
        }

        // Start trading system
        async function startSystem() {
            if (!confirm('Start the trading system?')) return;

            try {
                const response = await fetch('/api/system/start', {method: 'POST'});
                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ Trading system started!');
                    updateSystemButtons(true);
                } else {
                    alert('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error starting system:', error);
                alert('Error starting system');
            }
        }

        // Stop trading system
        async function stopSystem() {
            if (!confirm('Stop the trading system?')) return;

            try {
                const response = await fetch('/api/system/stop', {method: 'POST'});
                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ Trading system stopped!');
                    updateSystemButtons(false);
                } else {
                    alert('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error stopping system:', error);
                alert('Error stopping system');
            }
        }

        // Update start/stop buttons
        function updateSystemButtons(running) {
            if (running) {
                document.getElementById('start-btn').classList.add('hidden');
                document.getElementById('stop-btn').classList.remove('hidden');
            } else {
                document.getElementById('start-btn').classList.remove('hidden');
                document.getElementById('stop-btn').classList.add('hidden');
            }
        }

        // Fetch system status
        async function fetchStatus() {
            try {
                const response = await fetch('/api/status');
                const result = await response.json();

                if (result.success) {
                    const data = result.data;

                    // Update mode badge
                    const modeBadge = document.getElementById('mode-badge');
                    if (data.is_real_money) {
                        modeBadge.textContent = 'üî¥ LIVE (REAL)';
                        modeBadge.className = 'mode-badge mode-live';
                    } else if (data.is_live) {
                        modeBadge.textContent = 'üìù LIVE (PAPER)';
                        modeBadge.className = 'mode-badge mode-backtest';
                    } else {
                        modeBadge.textContent = 'üìù BACKTEST';
                        modeBadge.className = 'mode-badge mode-backtest';
                    }

                    // Update capital
                    document.getElementById('capital').textContent = formatCurrency(data.capital);
                    document.getElementById('capital-source').textContent =
                        data.capital_source === 'upstox' ? 'From Upstox' : 'Paper Money';

                    // Update system buttons
                    updateSystemButtons(data.system_running);
                }
            } catch (error) {
                console.error('Error fetching status:', error);
            }
        }

        // Fetch portfolio metrics
        async function fetchPortfolio() {
            try {
                const response = await fetch('/api/portfolio');
                const result = await response.json();

                if (result.success) {
                    const data = result.data;

                    // Total P&L
                    const totalPnl = document.getElementById('total-pnl');
                    totalPnl.textContent = formatCurrency(data.total_pnl);
                    totalPnl.className = 'stat-value ' + (data.total_pnl >= 0 ? 'positive' : 'negative');

                    // P&L breakdown
                    document.getElementById('pnl-breakdown').textContent =
                        `Realized: ${formatCurrency(data.realized_pnl)} | Unrealized: ${formatCurrency(data.unrealized_pnl)}`;

                    // Win rate
                    document.getElementById('win-rate').textContent = formatPercent(data.win_rate);

                    // Trades summary
                    const totalTrades = data.intraday.trades + data.swing.trades;
                    const totalWins = data.intraday.wins + data.swing.wins;
                    const totalLosses = data.intraday.losses + data.swing.losses;
                    document.getElementById('trades-summary').textContent =
                        `${totalWins}W / ${totalLosses}L of ${totalTrades} trades`;

                    // Portfolio heat
                    document.getElementById('portfolio-heat').textContent =
                        `Portfolio Heat: ${formatPercent(data.portfolio_heat)}`;
                }
            } catch (error) {
                console.error('Error fetching portfolio:', error);
            }
        }

        // Fetch open trades
        async function fetchOpenTrades() {
            try {
                const response = await fetch('/api/trades/open');
                const result = await response.json();

                const container = document.getElementById('open-trades-container');

                if (result.success) {
                    const trades = result.data.trades;

                    // Update open positions count
                    document.getElementById('open-positions').textContent = trades.length;

                    if (trades.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #999;">No open trades</p>';
                        return;
                    }

                    let html = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Direction</th>
                                    <th>Qty</th>
                                    <th>Entry</th>
                                    <th>Stop Loss</th>
                                    <th>Target</th>
                                    <th>Strategy</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    trades.forEach(trade => {
                        html += `
                            <tr>
                                <td><strong>${trade.symbol}</strong></td>
                                <td><span class="badge badge-${trade.direction.toLowerCase()}">${trade.direction}</span></td>
                                <td>${trade.quantity}</td>
                                <td>${formatCurrency(trade.entry_price)}</td>
                                <td>${formatCurrency(trade.stop_loss)}</td>
                                <td>${formatCurrency(trade.target)}</td>
                                <td>${trade.strategy}</td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error('Error fetching open trades:', error);
            }
        }

        // Fetch closed trades
        async function fetchClosedTrades() {
            try {
                const response = await fetch('/api/trades/closed?days=7');
                const result = await response.json();

                const container = document.getElementById('closed-trades-container');

                if (result.success) {
                    const trades = result.data.trades;

                    if (trades.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #999;">No closed trades in the last 7 days</p>';
                        return;
                    }

                    let html = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Direction</th>
                                    <th>Entry</th>
                                    <th>Exit</th>
                                    <th>P&L</th>
                                    <th>P&L %</th>
                                    <th>Exit Reason</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    trades.forEach(trade => {
                        const pnlClass = trade.net_pnl >= 0 ? 'positive' : 'negative';
                        html += `
                            <tr>
                                <td><strong>${trade.symbol}</strong></td>
                                <td><span class="badge badge-${trade.direction.toLowerCase()}">${trade.direction}</span></td>
                                <td>${formatCurrency(trade.entry_price)}</td>
                                <td>${formatCurrency(trade.exit_price)}</td>
                                <td class="${pnlClass}" style="font-weight: 600;">${formatCurrency(trade.net_pnl)}</td>
                                <td class="${pnlClass}" style="font-weight: 600;">${formatPercent(trade.pnl_percent)}</td>
                                <td>${trade.exit_reason}</td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error('Error fetching closed trades:', error);
            }
        }

        // Refresh all data
        function refreshAll() {
            fetchStatus();
            fetchPortfolio();
            fetchOpenTrades();
            fetchClosedTrades();
            document.getElementById('last-updated').textContent = 'Last updated: ' + new Date().toLocaleString();
        }

        // Initial load
        refreshAll();

        // Auto-refresh every 30 seconds
        setInterval(refreshAll, 30000);
    </script>
</body>
</html>
